---
/**
 * Spanish Card Detail Page
 * Loads card data from /data/es/cards.json with Spanish names/descriptions
 * UI elements (tags, labels) remain in English
 */
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { formatDescription, formatNumber, formatDate, formatSkillDescription } from '../../../lib/formatters';
import { getAttributeIconUrl, getTypeIconUrl, getStarIconUrl } from '../../../lib/icons';
import { getImageUrl, getAndroidImageWithFallback, getPlaceholderHD, getPlaceholderCircle } from '../../../lib/images';
import { getSimilarityReason } from '../../../lib/similarity';
import { getCollection } from 'astro:content';
import type { Card, CardsData } from '../../../types/card';
import CardPopups from '../../../components/cards/CardPopups';
import AuctionStockBadge from '../../../components/cards/AuctionStockBadge';
import AuctionEstimate from '../../../components/cards/AuctionEstimate';
import AvailabilityBadge from '../../../components/cards/AvailabilityBadge';

// Import locale cards data and English skills data at build time
import cardsDataRaw from '../../../data/es/cards.json';
import skillsDataRaw from '../../../data/skills.json';
import cardMentionsRaw from '../../../data/card_mentions.json';
import similarCardsRaw from '../../../data/similar_cards.json';
import gameBugsRaw from '../../../data/game_bugs.json';
import auctionsDataRaw from '../../../data/auctions.json';

// For similar cards, we use English data to get names for linking
import enCardsDataRaw from '../../../data/cards.json';

// Type for card mentions
interface CardMention {
  slug: string;
  title: string;
  date: string;
}
type CardMentionsData = Record<string, CardMention[]>;

// Type for pre-computed similar cards
interface SimilarCardEntry {
  id: string;
  score: number;
  sameAttribute: boolean;
  sameType: boolean;
}
type SimilarCardsData = Record<string, SimilarCardEntry[]>;


// Type for game bugs
interface GameBug {
  id: string;
  card_id: number;
  card_name: string;
  affected_field: 'ability' | 'skill' | 'stats';
  affected_id: string;
  category: 'targeting' | 'description' | 'effect_type' | 'unit_type' | 'stats' | 'missing_duration';
  severity: 'gameplay' | 'visual';
  summary: string;
  details: {
    description_says?: string;
    de_field?: string;
    target_string?: string;
    missing?: string;
    description_percentage?: number;
    actual_percentage?: number;
    expected_effect?: string;
    actual_effect?: string;
    description_percentages?: number[];
    data_percentages?: number[];
    missing_effect?: string;
    chit_atk_effect?: string;
    expected_format?: string;
    current_crit?: number;
    expected_crit?: number;
    unit_type?: string;
    explanation?: string;
  };
  analysis: string;
  affects_gameplay: boolean;
  visual_only: boolean;
  status: 'open' | 'fixed' | 'wont_fix';
  first_detected?: string;
  last_checked?: string;
  fixed_in_version?: string;
}
type GameBugsData = {
  version: string;
  bugs: GameBug[];
};

// Type for auction data (stock only, no pricing)
interface AuctionCardData {
  card_id: string;
  first_seen: string;
  last_seen: string;
  last_count: number;
}
type AuctionsData = {
  last_updated: string;
  active_count: number;
  total_tracked: number;
  cards: Record<string, AuctionCardData>;
};

const currentLocale = 'es';

export async function getStaticPaths() {
  const cardsData = cardsDataRaw as unknown as CardsData;

  const paths = Object.keys(cardsData.cards).map(id => ({
    params: { id },
    props: { card: cardsData.cards[id] }
  }));

  return paths;
}

const cardsData = cardsDataRaw as unknown as CardsData;
const enCardsData = enCardsDataRaw as unknown as CardsData;
const skillsData = (skillsDataRaw as any).skills || {};
const cardMentions = cardMentionsRaw as CardMentionsData;
const similarCardsData = similarCardsRaw as SimilarCardsData;
const gameBugsData = gameBugsRaw as GameBugsData;
const auctionsData = auctionsDataRaw as AuctionsData;

const { card } = Astro.props as { card: Card };

// Get live auction data for this card (if tracked)
const cardAuctionData = auctionsData.cards?.[card.id] || null;

// Helper to calculate stock level from auction data
// Matches pipeline's calculate_stock_level() in auction_tracker.py
// Stock levels (based on last week's activity):
// - high: 5+ copies available (can buy full MLB)
// - medium: 2-4 copies available
// - low: 1 copy available
// - unavailable: Not seen in last week
function getStockLevel(auctionData: AuctionCardData | null): 'high' | 'medium' | 'low' | 'unavailable' {
  if (!auctionData || !auctionData.last_seen) return 'unavailable';

  const lastSeen = new Date(auctionData.last_seen);
  const now = new Date();
  const daysSinceLastSeen = (now.getTime() - lastSeen.getTime()) / (1000 * 60 * 60 * 24);

  // Not seen in last week = unavailable
  if (daysSinceLastSeen > 7) return 'unavailable';

  // Seen within last week - check count
  const count = auctionData.last_count || 0;

  if (count >= 5) return 'high';
  if (count >= 2) return 'medium';
  if (count >= 1) return 'low';

  return 'unavailable';
}

const stockLevel = getStockLevel(cardAuctionData);

// Compute reverse special bonds: which cards have special bonds targeting THIS card
interface ReverseBond {
  fromCardId: string;
  fromCardName: string;
  bondType: string;
  bonusPercent: number;
}
const receivesSpecialBondsFrom: ReverseBond[] = [];
for (const [otherId, otherCard] of Object.entries(cardsData.cards)) {
  if (!otherCard || otherId === card.id) continue;
  const typedCard = otherCard as Card;
  const bonds = typedCard.bonds || [];
  for (const bond of bonds) {
    if (bond.target_id === card.id) {
      receivesSpecialBondsFrom.push({
        fromCardId: otherId,
        fromCardName: typedCard.name || 'Unknown',
        bondType: bond.type,
        bonusPercent: bond.bonus_percent,
      });
    }
  }
}

// Get bugs for this card (filter out fixed bugs)
// Bug notices are rendered with data-dev-only attribute and hidden on production via client-side JS
const cardBugs = gameBugsData.bugs.filter(
  bug => bug.card_id === parseInt(card.id) && bug.status !== 'fixed'
);
const skillBug = cardBugs.find(bug => bug.affected_field === 'skill');
const abilityBugs = cardBugs.filter(bug => bug.affected_field === 'ability');
const statsBugs = cardBugs.filter(bug => bug.affected_field === 'stats');

// Helper to get all bugs for a specific ability
function getAbilityBugs(abilityId: string): GameBug[] {
  return abilityBugs.filter(bug => bug.affected_id === abilityId);
}

// Get skill data for formatting
const skillData = card.skill ? skillsData[card.skill.id] : null;

// Get blog posts that mention this card
const relatedGuidesRaw = cardMentions[card.id] || [];

// Fetch localized blog posts to get translated titles
const localizedPosts = await getCollection('blog', ({ id }) => id.startsWith('es/'));
const titleLookup: Record<string, string> = {};
for (const post of localizedPosts) {
  const baseSlug = post.id.replace('es/', '');
  titleLookup[baseSlug] = post.data.title;
}

// Map guides with localized titles (fallback to English if not found)
const relatedGuides = relatedGuidesRaw.map(guide => ({
  ...guide,
  title: titleLookup[guide.slug] || guide.title
}));

// Get pre-computed similar cards (computed at sync time for faster builds)
const precomputedSimilar = similarCardsData[card.id] || [];
const similarCards = precomputedSimilar.map(entry => ({
  card: enCardsData.cards[entry.id] as Card,
  score: entry.score,
  details: {
    sameAttribute: entry.sameAttribute,
    sameType: entry.sameType,
    sameRarity: enCardsData.cards[entry.id]?.stats?.rarity === card.stats.rarity,
    matchingSkillTags: [] as string[],
    matchingAbilityTags: [] as string[],
    score: entry.score,
  }
})).filter(item => item.card);

// Get tier data for this card (if available)

// Get image URLs
const hdImageUrl = getImageUrl(card, 'hd');
const seoImage = hdImageUrl || undefined;

// Helper to get localized card URL
const getCardUrl = (cardId: string) => `/${currentLocale}/cards/${cardId}`;

// SEO: Title limit: 60 chars (+ " | OtogiDB" = 70 max), Description limit: 160 chars
const cardName = card.name || `Daemon #${card.id}`;
const skillName = card.skill?.name || '';
const artistName = card.meta?.artist_name || null;

const seoTitle = `${cardName} - Otogi ${card.stats.rarity}★ ${card.stats.attribute_name} ${card.stats.type_name}`;
const seoDescription = `${cardName} en Otogi: Spirit Agents. ${card.stats.rarity}★ ${card.stats.attribute_name} ${card.stats.type_name} con ${formatNumber(card.stats.max_atk)} ATK, ${formatNumber(card.stats.max_hp)} HP.${skillName ? ` Skill: ${skillName}.` : ''}`;

// Build creator array - include artist if available
const creators: Array<{ "@type": string; name: string }> = [
  { "@type": "Organization", "name": "MyRealLife Games" },
  { "@type": "Organization", "name": "Mitama Games" }
];
if (artistName) {
  creators.push({ "@type": "Person", "name": artistName });
}

// Build keywords - include artist if available
const keywordParts = [cardName, 'Otogi Spirit Agents', card.stats.attribute_name, card.stats.type_name, 'skills', 'abilities'];
if (artistName) keywordParts.push(artistName);

// JSON-LD structured data - enhanced for SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "name": cardName,
  "description": seoDescription,
  "image": seoImage,
  "url": `https://otogidb.com/${currentLocale}/cards/${card.id}`,
  "inLanguage": currentLocale,
  "keywords": keywordParts.join(', '),
  "creator": creators,
  "isPartOf": {
    "@type": "VideoGame",
    "name": "Otogi: Spirit Agents",
    "gamePlatform": ["iOS", "Android"]
  }
};
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  image={seoImage}
  lang={currentLocale}
  hasLocalizedUrls={true}
>
  <!-- JSON-LD Structured Data -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6">
    <!-- Breadcrumb with language indicator -->
    <nav class="mb-3 sm:mb-4 text-xs sm:text-sm flex items-center justify-between">
      <div>
        <a href={`/${currentLocale}`} class="link">Cards</a>
        <span class="mx-1 sm:mx-2">/</span>
        <span class="text-secondary truncate">{card.name || `Card #${card.id}`}</span>
      </div>
    </nav>

    <!-- Mobile Header -->
    <div class="md:hidden mb-3" aria-hidden="true">
      <div class="flex items-center justify-between gap-2 mb-2">
        <div class="flex items-center gap-2 min-w-0">
          <div class="text-xl font-bold truncate">{card.name || `Card #${card.id}`}</div>
          {!card.playable && (
            <span class="px-1.5 py-0.5 text-[10px] rounded bg-orange-500/20 text-orange-400 font-medium flex-shrink-0 cursor-help" title="NPC/Enemy card - not obtainable by players">NPC</span>
          )}
        </div>
        <span class="text-xs font-mono text-secondary flex-shrink-0">#{card.id}</span>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="inline-flex items-center gap-1">
          <img src={getAttributeIconUrl(card.stats.attribute_name, { width: 32 })} alt={card.stats.attribute_name} class="w-5 h-5 object-contain" />
          <span class="text-xs">{card.stats.attribute_name}</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <img src={getTypeIconUrl(card.stats.type_name, { width: 32 })} alt={card.stats.type_name} class="w-5 h-5 object-contain" />
          <span class="text-xs">{card.stats.type_name}</span>
        </span>
        <span class="inline-flex items-center">
          {Array.from({ length: card.stats.rarity }, () => null).map(() => (
            <img src={getStarIconUrl({ width: 32 })} alt="★" class="w-4 h-4 object-contain -ml-0.5 first:ml-0" />
          ))}
        </span>
      </div>
    </div>

    <div class="grid md:grid-cols-5 lg:grid-cols-3 gap-4 sm:gap-6">
      <!-- Card Image -->
      <div class="md:col-span-2 lg:col-span-1">
        <div class="card p-3 sm:p-4 md:sticky md:top-20">
          <div class="flex justify-center md:block">
            <img
              src={hdImageUrl || getPlaceholderHD()}
              alt={`${card.name || `Card #${card.id}`} - Otogi Spirit Agents ${card.stats.rarity}★ ${card.stats.attribute_name} ${card.stats.type_name} daemon artwork`}
              class="w-full max-w-[280px] sm:max-w-none h-auto rounded-lg"
              loading="eager"
              onerror={`this.onerror=null; this.src='${getPlaceholderHD()}';`}
            />
          </div>

          <!-- Quick Stats (Mobile/Tablet) -->
          <div class="lg:hidden mt-3 sm:mt-4 grid grid-cols-4 gap-1.5 sm:gap-2 text-xs sm:text-sm">
            <div class="text-center p-1.5 sm:p-2 rounded" style="background-color: var(--color-surface);">
              <div class="text-secondary text-[10px] sm:text-xs">ATK</div>
              <div class="font-bold font-mono text-sm sm:text-base">{formatNumber(card.stats.max_atk)}</div>
            </div>
            <div class="text-center p-1.5 sm:p-2 rounded" style="background-color: var(--color-surface);">
              <div class="text-secondary text-[10px] sm:text-xs">HP</div>
              <div class="font-bold font-mono text-sm sm:text-base">{formatNumber(card.stats.max_hp)}</div>
            </div>
            <div class="text-center p-1.5 sm:p-2 rounded" style="background-color: var(--color-surface);">
              <div class="text-secondary text-[10px] sm:text-xs">SPD</div>
              <div class="font-bold font-mono text-sm sm:text-base">{formatNumber(card.stats.speed)}</div>
            </div>
            <div class="text-center p-1.5 sm:p-2 rounded" style="background-color: var(--color-surface);">
              <div class="text-secondary text-[10px] sm:text-xs">CRIT</div>
              <div class="font-bold font-mono text-sm sm:text-base">{formatNumber(card.stats.crit)}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Info -->
      <div class="md:col-span-3 lg:col-span-2 space-y-4 sm:space-y-6">
        <!-- Header (Desktop) -->
        <div class="hidden md:block">
          <div class="flex items-center gap-3 mb-2">
            <h1 class="text-2xl lg:text-3xl font-bold">{card.name || `Card #${card.id}`}</h1>
            {!card.playable && (
              <span class="px-2 py-1 text-xs rounded bg-orange-500/20 text-orange-400 font-medium cursor-help" title="NPC/Enemy card - not obtainable by players">NPC</span>
            )}
            <span class="text-sm font-mono text-secondary">#{card.id}</span>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <span class="inline-flex items-center gap-1" title={card.stats.attribute_name}>
              <img src={getAttributeIconUrl(card.stats.attribute_name, { width: 48 })} alt={card.stats.attribute_name} class="w-6 h-6 object-contain" loading="lazy" decoding="async" />
              <span class="text-sm">{card.stats.attribute_name}</span>
            </span>
            <span class="inline-flex items-center gap-1" title={card.stats.type_name}>
              <img src={getTypeIconUrl(card.stats.type_name, { width: 48 })} alt={card.stats.type_name} class="w-6 h-6 object-contain" loading="lazy" decoding="async" />
              <span class="text-sm">{card.stats.type_name}</span>
            </span>
            <span class="inline-flex items-center" title={`${card.stats.rarity} Stars`}>
              {Array.from({ length: card.stats.rarity }, () => null).map(() => (
                <img src={getStarIconUrl({ width: 40 })} alt="★" class="w-5 h-5 object-contain -ml-0.5 first:ml-0" loading="lazy" decoding="async" />
              ))}
            </span>
          </div>
        </div>

        <!-- Description -->
        {card.description && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-1.5 sm:mb-2 text-sm sm:text-base">Description</h2>
            <div class="text-xs sm:text-sm leading-relaxed" set:html={formatDescription(card.description)} />
          </div>
        )}

        <!-- Stats (Desktop) -->
        <div class="hidden lg:block card p-4">
          <h2 class="font-semibold mb-4">Stats</h2>
          <div class="grid grid-cols-4 gap-4">
            <div>
              <div class="text-secondary text-sm">Max ATK</div>
              <div class="text-xl font-bold font-mono">{formatNumber(card.stats.max_atk)}</div>
              <div class="text-xs text-secondary">Base: {formatNumber(card.stats.base_atk)}</div>
            </div>
            <div>
              <div class="text-secondary text-sm">Max HP</div>
              <div class="text-xl font-bold font-mono">{formatNumber(card.stats.max_hp)}</div>
              <div class="text-xs text-secondary">Base: {formatNumber(card.stats.base_hp)}</div>
            </div>
            <div>
              <div class="text-secondary text-sm">Speed</div>
              <div class="text-xl font-bold font-mono">{formatNumber(card.stats.speed)}</div>
            </div>
            <div>
              <div class="text-secondary text-sm">Crit Rate</div>
              <div class="text-xl font-bold font-mono">{formatNumber(card.stats.crit)}</div>
            </div>
          </div>
          {/* Stats bugs notice */}
          {statsBugs.length > 0 && (
            <>
              {statsBugs.map(bug => (
                <div data-dev-only class={`mt-3 p-2 sm:p-3 rounded-lg border ${bug.affects_gameplay ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'}`}>
                  <div class="flex items-start gap-2">
                    <span class={`text-sm ${bug.affects_gameplay ? 'text-red-500' : 'text-yellow-500'}`}>⚠</span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 flex-wrap">
                        <span class={`text-xs font-medium ${bug.affects_gameplay ? 'text-red-700 dark:text-red-400' : 'text-yellow-700 dark:text-yellow-400'}`}>
                          {bug.affects_gameplay ? 'Stats Bug' : 'Stats Issue'}
                        </span>
                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-500/20 text-gray-600 dark:text-gray-400 font-mono">
                          {bug.id}
                        </span>
                      </div>
                      <p class="text-xs text-secondary mt-1">{bug.summary}</p>
                      {bug.details.current_crit !== undefined && bug.details.expected_crit !== undefined && (
                        <div class="text-xs mt-1.5 space-y-0.5">
                          <div><span class="text-secondary">Current:</span> <span class="line-through opacity-60">{bug.details.current_crit}</span></div>
                          <div><span class="text-secondary">Expected:</span> <span class="font-medium">{bug.details.expected_crit}</span></div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>

        <!-- Skill -->
        {card.skill && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-1.5 sm:mb-2 text-sm sm:text-base">Skill</h2>
            <div class="text-base sm:text-lg font-medium mb-1" style="color: var(--color-accent);">
              {card.skill.name || 'Unknown Skill'}
            </div>
            <div class="text-xs sm:text-sm mb-2" set:html={formatSkillDescription(card.skill.description, skillData, card.stats.rarity) || 'No description available'} />
            {card.skill.tags && card.skill.tags.length > 0 && (
              <div class="flex flex-wrap gap-1 sm:gap-1.5 mt-2">
                {card.skill.tags.map(tag => (
                  <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full" style="background-color: var(--color-surface); color: var(--color-accent);">
                    {tag}
                  </span>
                ))}
              </div>
            )}
            {/* Bug notice for skill */}
            {skillBug && (
              <div data-dev-only class={`mt-3 p-2 sm:p-3 rounded-lg border ${skillBug.affects_gameplay ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'}`}>
                <div class="flex items-start gap-2">
                  <span class={`text-sm ${skillBug.affects_gameplay ? 'text-red-500' : 'text-yellow-500'}`}>⚠</span>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class={`text-xs font-medium ${skillBug.affects_gameplay ? 'text-red-700 dark:text-red-400' : 'text-yellow-700 dark:text-yellow-400'}`}>
                        {skillBug.affects_gameplay ? 'Gameplay Bug' : 'Description Mismatch'}
                      </span>
                      <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-500/20 text-gray-600 dark:text-gray-400 font-mono">
                        {skillBug.id}
                      </span>
                    </div>
                    <p class="text-xs text-secondary mt-1">{skillBug.summary}</p>
                    {skillBug.details.description_percentage !== undefined && skillBug.details.actual_percentage !== undefined && (
                      <div class="text-xs mt-1.5 space-y-0.5">
                        <div><span class="text-secondary">Description:</span> <span class="line-through opacity-60">{skillBug.details.description_percentage}%</span></div>
                        <div><span class="text-secondary">Actual:</span> <span class="font-medium">{skillBug.details.actual_percentage}%</span></div>
                      </div>
                    )}
                    {skillBug.details.expected_effect && skillBug.details.actual_effect && (
                      <div class="text-xs mt-1.5 space-y-0.5">
                        <div><span class="text-secondary">Description says:</span> <span class="line-through opacity-60">{skillBug.details.expected_effect}</span></div>
                        <div><span class="text-secondary">Actual effect:</span> <span class="font-medium">{skillBug.details.actual_effect}</span></div>
                      </div>
                    )}
                    {skillBug.details.missing_effect && (
                      <div class="text-xs mt-1.5">
                        <span class="text-secondary">Missing effect:</span> <code class="text-[10px] bg-red-500/20 px-1 rounded">{skillBug.details.missing_effect}</code>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        <!-- Abilities -->
        {card.abilities.length > 0 && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Abilities</h2>
            <div class="space-y-3 sm:space-y-4">
              {card.abilities.map(ability => (
                <div>
                  <div class="flex items-center gap-1.5 sm:gap-2 flex-wrap">
                    <span class="font-medium text-sm sm:text-base" style="color: var(--color-highlight);">
                      {ability.name}
                    </span>
                    {ability.unlock_level && (
                      <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded" style="background-color: var(--color-surface); color: var(--color-text-secondary);">
                        Lv. {ability.unlock_level}
                      </span>
                    )}
                    {ability.stackable === false && (
                      <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded bg-orange-500/20 text-orange-400 cursor-help" title="Solo se aplica una vez por tu equipo - los duplicados no se acumulan. La copia de un amigo/ayudante SÍ se acumula con la de tu equipo.">
                        1x propio equipo
                      </span>
                    )}
                  </div>
                  <div class="text-xs sm:text-sm text-secondary mt-0.5">
                    {ability.description}
                  </div>
                  {ability.tags && ability.tags.length > 0 && (
                    <div class="flex flex-wrap gap-1 sm:gap-1.5 mt-1.5">
                      {ability.tags.map(tag => (
                        <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full" style="background-color: var(--color-surface); color: var(--color-highlight);">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                  {/* Bug notices for this ability */}
                  {(() => {
                    const bugs = getAbilityBugs(ability.id);
                    if (bugs.length === 0) return null;
                    return (
                      <div class="mt-2 space-y-2">
                        {bugs.map(bug => (
                          <div data-dev-only class={`p-2 sm:p-3 rounded-lg border ${bug.affects_gameplay ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'}`}>
                            <div class="flex items-start gap-2">
                              <span class={`text-sm ${bug.affects_gameplay ? 'text-red-500' : 'text-yellow-500'}`}>⚠</span>
                              <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 flex-wrap">
                                  <span class={`text-xs font-medium ${bug.affects_gameplay ? 'text-red-700 dark:text-red-400' : 'text-yellow-700 dark:text-yellow-400'}`}>
                                    {bug.affects_gameplay ? 'Gameplay Bug' : 'Description Mismatch'}
                                  </span>
                                  <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-500/20 text-gray-600 dark:text-gray-400 font-mono">
                                    {bug.id}
                                  </span>
                                </div>
                                <p class="text-xs text-secondary mt-1">{bug.summary}</p>
                                {bug.details.description_percentage !== undefined && bug.details.actual_percentage !== undefined && (
                                  <div class="text-xs mt-1.5 space-y-0.5">
                                    <div><span class="text-secondary">Description:</span> <span class="line-through opacity-60">{bug.details.description_percentage}%</span></div>
                                    <div><span class="text-secondary">Actual:</span> <span class="font-medium">{bug.details.actual_percentage}%</span></div>
                                  </div>
                                )}
                                {bug.details.target_string && bug.details.missing && (
                                  <div class="text-xs mt-1.5 space-y-0.5">
                                    <div><span class="text-secondary">Actual:</span> <code class="text-[10px] bg-gray-500/20 px-1 rounded">{bug.details.target_string}</code></div>
                                    <div><span class="text-secondary">Missing:</span> <code class="text-[10px] bg-red-500/20 px-1 rounded">{bug.details.missing}</code></div>
                                  </div>
                                )}
                                {bug.details.expected_effect && bug.details.actual_effect && (
                                  <div class="text-xs mt-1.5 space-y-0.5">
                                    <div><span class="text-secondary">Description says:</span> <span class="line-through opacity-60">{bug.details.expected_effect}</span></div>
                                    <div><span class="text-secondary">Actual effect:</span> <span class="font-medium">{bug.details.actual_effect}</span></div>
                                  </div>
                                )}
                                {bug.details.missing_effect && (
                                  <div class="text-xs mt-1.5">
                                    <span class="text-secondary">Missing effect:</span> <code class="text-[10px] bg-red-500/20 px-1 rounded">{bug.details.missing_effect}</code>
                                  </div>
                                )}
                                {bug.details.chit_atk_effect && (
                                  <div class="text-xs mt-1.5 space-y-0.5">
                                    <div><span class="text-secondary">Effect:</span> <code class="text-[10px] bg-red-500/20 px-1 rounded">{bug.details.chit_atk_effect}</code></div>
                                    {bug.details.expected_format && (
                                      <div><span class="text-secondary">Expected:</span> <code class="text-[10px] bg-green-500/20 px-1 rounded">{bug.details.expected_format}</code></div>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Synergy Partners -->
        {card.synergies && card.synergies.length > 0 && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Socios de Sinergia</h2>
            <p class="text-xs text-secondary mb-3">Cartas que activan las habilidades de bonificación de equipo</p>
            <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-2">
              {card.synergies.map(partnerId => {
                const partner = cardsData.cards[partnerId];
                if (!partner) return null;
                return (
                  <a
                    href={getCardUrl(partnerId)}
                    class="synergy-card text-center group"
                    data-card-id={partnerId}
                  >
                    <img
                      src={getAndroidImageWithFallback(partner)}
                      alt={partner.name || `Card #${partnerId}`}
                      class="w-12 h-12 sm:w-14 sm:h-14 rounded-full mx-auto object-cover group-hover:ring-2 ring-offset-1 transition-all"
                      style="--tw-ring-color: var(--color-accent); --tw-ring-offset-color: var(--color-bg);"
                      loading="lazy"
                      onerror={`this.onerror=null; this.src='${getPlaceholderCircle()}';`}
                    />
                    <div class="text-[9px] sm:text-[10px] truncate mt-1 group-hover:text-accent transition-colors">
                      {partner.name || `#${partnerId}`}
                    </div>
                  </a>
                );
              })}
            </div>
          </div>
        )}

        <!-- Bonds -->
        {card.bonds && card.bonds.length > 0 && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Bonds</h2>
            <div class="space-y-2 sm:space-y-3">
              {card.bonds.map(bond => {
                const isSpecial = bond.target_id && bond.target_id !== '';
                const targetCard = isSpecial ? cardsData.cards[bond.target_id] : null;
                return (
                  <div class="flex items-center justify-between gap-2 p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                    <div class="flex items-center gap-2 min-w-0 flex-wrap">
                      <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded font-medium flex-shrink-0 cursor-help"
                            style={`background-color: var(--color-${bond.type === 'Attack' || bond.type === 'Skill' ? 'error' : bond.type === 'HP' ? 'highlight' : 'accent'}); color: var(--color-bg); opacity: 0.9;`}
                            title={bond.type === 'Attack' ? 'Boosts ATK stat when bonded' : bond.type === 'Skill' ? 'Boosts Skill DMG when bonded' : bond.type === 'HP' ? 'Boosts HP stat when bonded' : 'Bond stat boost'}>
                          {bond.type}
                      </span>
                      {isSpecial && (
                        <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded font-medium flex-shrink-0 cursor-help"
                              style="background-color: var(--color-highlight); color: var(--color-bg);"
                              title="Requires a specific partner card on the team to activate">
                          Special
                        </span>
                      )}
                      {targetCard && (
                        <a href={getCardUrl(bond.target_id)} class="text-xs sm:text-sm truncate link">
                          {targetCard.name}
                        </a>
                      )}
                      {bond.name && !targetCard && (
                        <span class="text-xs sm:text-sm truncate" style="color: var(--color-highlight);">
                          {bond.name}
                        </span>
                      )}
                    </div>
                    <div class="text-sm sm:text-base font-bold font-mono flex-shrink-0" style="color: var(--color-accent);">
                      +{bond.bonus_percent}%
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Receives Special Bonds From -->
        {receivesSpecialBondsFrom.length > 0 && (
          <div class="card p-3 sm:p-4">
            <h2 class="font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Recibe Vínculo Especial De</h2>
            <div class="space-y-2 sm:space-y-3">
              {receivesSpecialBondsFrom.map(bond => (
                <div class="flex items-center justify-between gap-2 p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                  <div class="flex items-center gap-2 min-w-0 flex-wrap">
                    <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded font-medium flex-shrink-0 cursor-help"
                          style={`background-color: var(--color-${bond.bondType === 'Attack' || bond.bondType === 'Skill' ? 'error' : bond.bondType === 'HP' ? 'highlight' : 'accent'}); color: var(--color-bg); opacity: 0.9;`}
                          title={bond.bondType === 'Attack' ? 'Boosts ATK stat when bonded' : bond.bondType === 'Skill' ? 'Boosts Skill DMG when bonded' : bond.bondType === 'HP' ? 'Boosts HP stat when bonded' : 'Bond stat boost'}>
                      {bond.bondType}
                    </span>
                    <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded font-medium flex-shrink-0"
                          style="background-color: var(--color-highlight); color: var(--color-bg);">
                      Special
                    </span>
                    <a href={getCardUrl(bond.fromCardId)} data-card-id={bond.fromCardId} class="text-xs sm:text-sm truncate link">
                      {bond.fromCardName}
                    </a>
                  </div>
                  <div class="text-sm sm:text-base font-bold font-mono flex-shrink-0" style="color: var(--color-accent);">
                    +{bond.bonusPercent}%
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Availability -->
        {card.acquisition && card.acquisition.sources.length > 0 && (
          <div class="card p-3 sm:p-4">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
              <h2 class="font-semibold text-sm sm:text-base">Disponibilidad</h2>
              <AvailabilityBadge
                client:load
                cardId={card.id}
                initialAvailable={card.acquisition.currently_available}
              />
            </div>

            <div class="space-y-3">
              {/* Gacha */}
              {card.acquisition.sources.includes('gacha') && (
                <div class="p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                  <div class="flex items-center gap-2 mb-1.5">
                    <span class="px-1.5 py-0.5 text-xs rounded bg-purple-500/20 text-purple-700 dark:text-purple-300 font-medium cursor-help" title="Obtenible a través del sistema de invocación usando joyas">Gacha</span>
                    {card.acquisition.gacha.in_standard_pool && (
                      <span class="text-xs text-green-700 dark:text-green-400 cursor-help" title="Se puede obtener de cualquier banner en cualquier momento">✓ Pool Estándar</span>
                    )}
                  </div>
                  {card.acquisition.gacha.featured_banners && card.acquisition.gacha.featured_banners.length > 0 && (
                    <div class="mt-2 space-y-1.5">
                      <div class="text-xs text-secondary">Banners Destacados:</div>
                      {card.acquisition.gacha.featured_banners.slice(0, 5).map(banner => (
                        <div class="text-xs flex items-center justify-between gap-2">
                          <span class="text-secondary">
                            {formatDate(banner.start)} - {formatDate(banner.end)}
                          </span>
                          <div class="flex items-center gap-2">
                            {banner.pity > 0 && (
                              <span class="text-yellow-700 dark:text-yellow-400" title="Pity threshold">Pity: {banner.pity}</span>
                            )}
                            {banner.is_current && (
                              <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-700 dark:text-green-400 text-[10px]">Activo</span>
                            )}
                          </div>
                        </div>
                      ))}
                      {card.acquisition.gacha.featured_banners.length > 5 && (
                        <div class="text-xs text-secondary">
                          +{card.acquisition.gacha.featured_banners.length - 5} more banners
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Auction */}
              {(card.acquisition.sources.includes('auction') || card.acquisition.auction?.estimate) && (() => {
                const auctionEstimate = card.acquisition.auction.estimate;

                return (
                  <div class="p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                    <div class="flex items-center justify-between gap-2">
                      <div class="flex items-center gap-2">
                        <span class="px-1.5 py-0.5 text-xs rounded bg-yellow-500/20 text-yellow-700 dark:text-yellow-300 font-medium">Subasta</span>
                        {card.acquisition.auction.is_time_limited && (
                          <span class="text-xs text-yellow-700 dark:text-yellow-400">(Tiempo Limitado)</span>
                        )}
                      </div>
                      <AuctionStockBadge
                        client:load
                        cardId={card.id}
                        initialStockLevel={stockLevel}
                      />
                    </div>
                    {auctionEstimate && (
                      <AuctionEstimate
                        client:load
                        cardId={card.id}
                        estimatedDate={formatDate(auctionEstimate.estimated_date)}
                        eventName={auctionEstimate.event_name}
                        note={auctionEstimate.note}
                        hasAuctionData={!!cardAuctionData}
                      />
                    )}
                  </div>
                );
              })()}

              {/* Exchange */}
              {card.acquisition.sources.includes('exchange') && (
                <div class="p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                  <div class="flex items-center gap-2 mb-1.5">
                    <span class="px-1.5 py-0.5 text-xs rounded bg-blue-500/20 text-blue-700 dark:text-blue-300 font-medium cursor-help" title="Comprable con moneda del juego (Mochi, Soulstones, etc.)">Intercambio</span>
                  </div>
                  {card.acquisition.exchange.entries && card.acquisition.exchange.entries.length > 0 && (
                    <div class="space-y-1.5">
                      {card.acquisition.exchange.entries.slice(0, 5).map(entry => {
                        const currencyDisplay = entry.currency === 'gApple' ? 'Mochi' :
                                               entry.currency === 'soulstone' ? 'Soulstones' :
                                               entry.currency;
                        return (
                          <div class="text-xs flex items-center justify-between gap-2">
                            <span class="text-secondary">
                              {formatDate(entry.start)} - {formatDate(entry.end)}
                            </span>
                            <div class="flex items-center gap-2">
                              <span>{formatNumber(entry.price)} {currencyDisplay}</span>
                              {entry.limit > 0 && (
                                <span class="text-secondary">(Limit: {entry.limit})</span>
                              )}
                              {entry.is_current && (
                                <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-700 dark:text-green-400 text-[10px]">Activo</span>
                              )}
                            </div>
                          </div>
                        );
                      })}
                      {card.acquisition.exchange.entries.length > 5 && (
                        <div class="text-xs text-secondary">
                          +{card.acquisition.exchange.entries.length - 5} more entries
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Event */}
              {card.acquisition.sources.includes('event') && (
                <div class="p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                  <div class="flex items-center gap-2 mb-1.5">
                    <span class="px-1.5 py-0.5 text-xs rounded bg-green-500/20 text-green-700 dark:text-green-300 font-medium cursor-help" title="Obtenible de eventos por tiempo limitado (recompensas de ranking, drops de torre, etc.)">Evento</span>
                  </div>
                  {card.acquisition.event.reward_tiers && card.acquisition.event.reward_tiers.length > 0 && (() => {
                    const seen = new Set();
                    const uniqueEvents = card.acquisition.event.reward_tiers.filter(tier => {
                      if (seen.has(tier.event_id)) return false;
                      seen.add(tier.event_id);
                      return true;
                    });
                    return (
                      <div class="space-y-1">
                        {uniqueEvents.map(tier => (
                          <div class="text-xs flex items-center justify-between gap-2">
                            <span>Recompensa de Ranking</span>
                            <div class="flex items-center gap-2">
                              <span class="text-secondary" title={`Event #${tier.event_id}`}>
                                {tier.event_name || `Event #${tier.event_id}`}
                              </span>
                              {tier.is_current && (
                                <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-700 dark:text-green-400 text-[10px]">Activo</span>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    );
                  })()}
                  {card.acquisition.event.tower_drops && card.acquisition.event.tower_drops.length > 0 && (
                    <div class="space-y-1 mt-2">
                      {card.acquisition.event.tower_drops.map(drop => (
                        <div class="text-xs">
                          <div class="flex items-center justify-between gap-2">
                            <span>
                              Drop de Torre
                              <span class="text-secondary ml-1">(Pisos: {drop.floors.join(', ')})</span>
                            </span>
                            <div class="flex items-center gap-2">
                              <span class="text-secondary" title={`Event #${drop.event_id}`}>
                                {drop.event_name || `Event #${drop.event_id}`}
                              </span>
                              {drop.is_current && (
                                <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-700 dark:text-green-400 text-[10px]">Activo</span>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  {card.acquisition.event.from_description && card.acquisition.event.from_description.length > 0 && (
                    <div class="space-y-1 mt-2">
                      {card.acquisition.event.from_description.map(desc => (
                        <div class="text-xs flex items-center justify-between gap-2">
                          <span>Carta de Evento</span>
                          <span class="text-secondary">{desc.event_name}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Daily Dungeon */}
              {card.acquisition.sources.includes('daily') && card.acquisition.daily?.available && (() => {
                const weekdayNames = ['', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const schedule = card.acquisition.daily.schedule || [];
                const scheduleDays = schedule.map((d) => weekdayNames[d] || `Day ${d}`).join(', ');
                const dropRate = card.acquisition.daily.drop_rate;
                return (
                  <div class="p-2 sm:p-3 rounded" style="background-color: var(--color-surface);">
                    <div class="flex items-center gap-2 mb-1.5">
                      <span class="px-1.5 py-0.5 text-xs rounded bg-cyan-500/20 text-cyan-700 dark:text-cyan-300 font-medium cursor-help" title="Farmeable en las batallas rotativas del Dungeon Diario">Dungeon Diario</span>
                      <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-700 dark:text-green-400 text-[10px]">Available</span>
                    </div>
                    <div class="text-xs space-y-1">
                      {dropRate !== null && (
                        <div>Probabilidad de Drop: <span class="font-medium">{dropRate}%</span></div>
                      )}
                      {schedule.length > 0 && (
                        <div>Horario: <span class="font-medium">{scheduleDays}</span></div>
                      )}
                      {schedule.length === 7 && (
                        <div class="text-secondary italic">Disponible todos los días</div>
                      )}
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        <!-- Info -->
        <div class="card p-3 sm:p-4">
          <h2 class="font-semibold mb-1.5 sm:mb-2 text-sm sm:text-base">Info</h2>
          <div class="grid grid-cols-2 gap-3 sm:gap-4 text-xs sm:text-sm">
            <div>
              <div class="text-secondary text-[10px] sm:text-xs">First Seen</div>
              <div>{formatDate(card.history.first_seen)}</div>
              <div class="text-[10px] sm:text-xs text-secondary">v{card.history.first_seen_version}</div>
            </div>
            <div>
              <div class="text-secondary text-[10px] sm:text-xs">Last Modified</div>
              <div>{formatDate(card.history.last_modified)}</div>
              <div class="text-[10px] sm:text-xs text-secondary">v{card.history.last_modified_version}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Guides (Blog posts mentioning this card) -->
    {relatedGuides.length > 0 && (
      <div class="mt-6 sm:mt-8">
        <h2 class="text-lg sm:text-xl font-bold mb-1.5 sm:mb-2">Related Guides</h2>
        <p class="text-xs sm:text-sm text-secondary mb-3 sm:mb-4">Blog posts featuring this card</p>
        <div class="grid gap-2 sm:gap-3">
          {relatedGuides.map(guide => (
            <a
              href={`/${currentLocale}/blog/${guide.slug}`}
              class="card p-3 sm:p-4 hover:ring-2 ring-accent transition-all flex items-center justify-between gap-3"
            >
              <div class="min-w-0">
                <div class="font-medium text-sm sm:text-base truncate">{guide.title}</div>
                <div class="text-xs text-secondary">{formatDate(guide.date)}</div>
              </div>
              <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Similar Cards -->
    {similarCards.length > 0 && (
      <div class="mt-6 sm:mt-8">
        <h2 class="text-lg sm:text-xl font-bold mb-1.5 sm:mb-2">Similar Cards</h2>
        <p class="text-xs sm:text-sm text-secondary mb-3 sm:mb-4">Good options for team replacements</p>
        <div class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 sm:gap-4">
          {similarCards.map(({ card: related, details }) => {
            const localeCard = cardsData.cards[related.id];
            const displayName = localeCard?.name || related.name || `Card #${related.id}`;
            return (
              <a href={getCardUrl(related.id)} class="card-grid-item text-center group p-1.5 sm:p-2">
                <div class="relative inline-block">
                  <img
                    src={getAndroidImageWithFallback(related)}
                    alt={displayName}
                    class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 rounded-full mx-auto object-cover"
                    loading="lazy"
                    onerror={`this.onerror=null; this.src='${getPlaceholderCircle()}';`}
                  />
                  <div class="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 flex gap-0.5">
                    {details.sameAttribute && (
                      <img
                        src={getAttributeIconUrl(related.stats.attribute_name, { width: 20 })}
                        alt={related.stats.attribute_name}
                        class="w-4 h-4 sm:w-5 sm:h-5 object-contain rounded-full"
                        style="background-color: var(--color-surface); padding: 1px;"
                        title="Same attribute"
                      />
                    )}
                    {details.sameType && (
                      <img
                        src={getTypeIconUrl(related.stats.type_name, { width: 20 })}
                        alt={related.stats.type_name}
                        class="w-4 h-4 sm:w-5 sm:h-5 object-contain rounded-full"
                        style="background-color: var(--color-surface); padding: 1px;"
                        title="Same type"
                      />
                    )}
                  </div>
                </div>
                <div class="text-[10px] sm:text-xs md:text-sm font-medium truncate mt-1.5">{displayName}</div>
                <div class="flex items-center justify-center gap-0.5 sm:gap-1 text-[10px] sm:text-xs">
                  <img src={getAttributeIconUrl(related.stats.attribute_name, { width: 24 })} alt={related.stats.attribute_name} class="w-3 h-3 sm:w-4 sm:h-4 object-contain" loading="lazy" decoding="async" />
                  <img src={getTypeIconUrl(related.stats.type_name, { width: 24 })} alt={related.stats.type_name} class="w-3 h-3 sm:w-4 sm:h-4 object-contain" loading="lazy" decoding="async" />
                  <span class="inline-flex items-center">
                    {Array.from({ length: related.stats.rarity }, () => null).map(() => (
                      <img src={getStarIconUrl({ width: 20 })} alt="★" class="w-2.5 h-2.5 sm:w-3 sm:h-3 object-contain -ml-0.5 first:ml-0" loading="lazy" decoding="async" />
                    ))}
                  </span>
                </div>
                <div class="hidden sm:block text-[10px] sm:text-xs text-secondary mt-1 opacity-75 group-hover:opacity-100 truncate">
                  {getSimilarityReason(details)}
                </div>
              </a>
            );
          })}
        </div>
      </div>
    )}
  </div>

  <!-- Card hover popups for synergy cards -->
  {card.synergies && card.synergies.length > 0 && (
    <CardPopups
      client:load
      cards={cardsData.cards}
      skills={skillsData}
      selector=".synergy-card"
    />
  )}
</BaseLayout>
